name: Deploy to Cloudflare

# Temporarily disabled - fix code issues first:
# - Missing firebase_options.dart
# - No cloudflare-workers/ directory in repo
# - Database compilation errors

on:
  workflow_dispatch:  # Manual trigger only
#  push:
#    branches: [main]
#  pull_request:
#    branches: [main]

# Cancel in-progress deployments on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-web:
    name: Deploy Flutter Web to Cloudflare Pages
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      deployments: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸŒ Build web (production)
        run: flutter build web --release --web-renderer canvaskit

      - name: ğŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: bookstrack-app
          directory: build/web
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}

  deploy-workers:
    name: Deploy API to Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      deployments: write

    defaults:
      run:
        working-directory: ./cloudflare-workers

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cloudflare-workers/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test

      - name: ğŸ”¨ Build Workers
        run: npm run build

      - name: ğŸš€ Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloudflare-workers
          command: deploy --env ${{ github.ref_name == 'main' && 'production' || 'preview' }}

      - name: ğŸ“ Comment PR with preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const previewUrl = `https://preview-${prNumber}.bookstrack-api.workers.dev`;

            const body = `## ğŸš€ Cloudflare Workers Deployment

            **Preview Environment:** ${previewUrl}

            ### API Endpoints:
            - \`GET ${previewUrl}/health\` - Health check
            - \`POST ${previewUrl}/api/search\` - Book search
            - \`POST ${previewUrl}/api/scan\` - AI bookshelf scan

            **Note:** Preview environment uses Gemini 2.0 Flash (free tier) instead of Pro for cost optimization.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  verify-deployment:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-workers]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 5

    steps:
      - name: ğŸ” Health Check - Web App
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bookstrack.pages.dev)
          if [ $response -ne 200 ]; then
            echo "âŒ Web app health check failed (HTTP $response)"
            exit 1
          fi
          echo "âœ… Web app is healthy"

      - name: ğŸ” Health Check - Workers API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bookstrack-api.workers.dev/health)
          if [ $response -ne 200 ]; then
            echo "âŒ Workers API health check failed (HTTP $response)"
            exit 1
          fi
          echo "âœ… Workers API is healthy"

      - name: ğŸ“Š Report deployment success
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sha = context.sha.substring(0, 7);
            const body = `## âœ… Production Deployment Successful

            **Commit:** ${sha}
            **Web App:** https://bookstrack.pages.dev
            **API:** https://bookstrack-api.workers.dev

            All health checks passed! ğŸ‰
            `;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });
