# Firebase Configuration Setup Guide

⚠️ **CRITICAL:** This project uses Firebase for authentication, database, and storage. Configuration files contain API keys and **must NOT be committed to git**.

## Prerequisites

- Firebase project created: `flutter-books` (ID: flutter-books-857d3)
- Access to [Firebase Console](https://console.firebase.google.com/project/flutter-books-857d3)

## Step 1: Download Configuration Files

### Android
1. Go to Firebase Console → Project Settings → Your apps
2. Select Android app (or add new app if needed)
   - Package name: `com.example.books_flutter` (or your package name)
3. Download `google-services.json`
4. Place in: `android/app/google-services.json`

### iOS
1. Go to Firebase Console → Project Settings → Your apps
2. Select iOS app (or add new app if needed)
   - Bundle ID: Should match your iOS bundle identifier
3. Download `GoogleService-Info.plist`
4. Place in: `ios/Runner/GoogleService-Info.plist`

### macOS
1. Use the same `GoogleService-Info.plist` from iOS
2. Place a copy in: `macos/Runner/GoogleService-Info.plist`

### Web (Optional)
1. Go to Firebase Console → Project Settings → Your apps
2. Select Web app
3. Copy configuration and update `lib/firebase_options.dart` (auto-generated by FlutterFire CLI)

## Step 2: Verify .gitignore

Ensure these files are in `.gitignore`:

```gitignore
# Firebase configuration files (contain API keys)
**/android/app/google-services.json
**/ios/Runner/GoogleService-Info.plist
**/macos/Runner/GoogleService-Info.plist
firebase.json
.firebaserc
```

**IMPORTANT:** Never commit these files to git! They contain sensitive API keys.

## Step 3: Configure Firebase Services

### Enable Required Services
In Firebase Console, enable:
- ✅ Authentication (Email/Password, Google Sign-In)
- ✅ Cloud Firestore
- ✅ Storage
- ✅ Analytics
- ✅ Crashlytics

### Set Up Security Rules

**Firestore Rules** (`firestore.rules`):
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Require authentication for all reads/writes
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // User-specific data
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Library entries
    match /library/{userId}/works/{workId} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
```

**Storage Rules** (`storage.rules`):
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth.uid == userId;
    }

    match /scans/{userId}/{allPaths=**} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
```

## Step 4: API Key Restrictions (Security Best Practice)

### Google Cloud Console
1. Go to: [API Credentials](https://console.cloud.google.com/apis/credentials?project=flutter-books-857d3)
2. For each API key:
   - Click "Edit"
   - **Application restrictions:**
     - Android: Select "Android apps" → Add package name & SHA-1
     - iOS: Select "iOS apps" → Add bundle ID
   - **API restrictions:** Restrict to:
     - Firebase Authentication API
     - Cloud Firestore API
     - Firebase Storage API
     - Firebase Analytics API
     - Identity Toolkit API
   - Save changes

### Get SHA-1 for Android
```bash
# Debug keystore (development)
keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android

# Release keystore (production)
keytool -list -v -keystore path/to/release.keystore -alias your-alias
```

Add SHA-1 fingerprints to Firebase Console → Project Settings → Android app.

## Step 5: FlutterFire CLI (Recommended)

Install FlutterFire CLI for automatic configuration:

```bash
# Install
dart pub global activate flutterfire_cli

# Configure (interactive)
flutterfire configure

# This will:
# - Create/update firebase_options.dart
# - Register apps if needed
# - Download configuration files
```

**Note:** FlutterFire CLI generates `lib/firebase_options.dart` which is also gitignored for safety.

## Step 6: Initialize Firebase in App

The app initializes Firebase in `lib/main.dart`:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(const ProviderScope(child: BooksTrackerApp()));
}
```

## Verification

### Check Configuration
```bash
# Run the app
flutter run -d <device>

# Check logs for Firebase initialization
# Should see: "Firebase initialized successfully"
```

### Test Firebase Services
1. **Authentication:** Try signing in/up
2. **Firestore:** Check database writes in Firebase Console
3. **Storage:** Upload test image
4. **Analytics:** View events in Firebase Console (24-48 hour delay)

## Security Checklist

- [ ] Configuration files are in `.gitignore`
- [ ] API keys have application restrictions (Android package, iOS bundle)
- [ ] API keys have API restrictions (only required Firebase APIs)
- [ ] Firestore rules require authentication
- [ ] Storage rules restrict access to user's own data
- [ ] Billing alerts are set up in Google Cloud Console
- [ ] Firebase App Check is enabled (recommended for production)

## Troubleshooting

### "Default Firebase app not initialized"
- Verify configuration files are in correct locations
- Check `firebase_options.dart` exists
- Ensure `Firebase.initializeApp()` is called before `runApp()`

### "API key is invalid"
- Regenerate configuration files from Firebase Console
- Check API key restrictions don't block your app

### Build errors on Android
- Verify `google-services.json` is in `android/app/`
- Check `android/build.gradle` has `classpath 'com.google.gms:google-services:4.4.0'`
- Check `android/app/build.gradle` has `apply plugin: 'com.google.gms.google-services'`

### Build errors on iOS/macOS
- Verify `GoogleService-Info.plist` is added to Xcode project
- Check file is in "Copy Bundle Resources" build phase
- Clean build folder: `flutter clean && flutter pub get`

## Production Deployment

### Before Publishing

1. **Regenerate API keys** for production
2. **Use release keystores** with proper SHA-1
3. **Enable Firebase App Check:**
   ```dart
   await FirebaseAppCheck.instance.activate(
     androidProvider: AndroidProvider.playIntegrity,
     appleProvider: AppleProvider.appAttest,
   );
   ```
4. **Set up monitoring:**
   - Firebase Crashlytics
   - Firebase Performance Monitoring
   - Billing alerts

### Environment Separation

Consider separate Firebase projects:
- `flutter-books-dev` (development)
- `flutter-books-staging` (testing)
- `flutter-books-prod` (production)

Use flavors or build variants to switch between environments.

## Support

- [Firebase Documentation](https://firebase.google.com/docs/flutter/setup)
- [FlutterFire Documentation](https://firebase.flutter.dev/)
- [Firebase Console](https://console.firebase.google.com/)
- [Google Cloud Console](https://console.cloud.google.com/)

---

**Last Updated:** November 12, 2025
**Project:** flutter-books (flutter-books-857d3)
